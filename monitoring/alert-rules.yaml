# ğŸš¨ æ­¯ç§‘æ¥­ç•Œé©å‘½ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«å®šç¾©
# å²ä¸Šæœ€å¼·ã®å“è³ªç¶­æŒã®ãŸã‚ã®åŒ…æ‹¬çš„ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

groups:
  - name: dental_revolution_critical
    interval: 30s
    rules:
      # ã‚·ã‚¹ãƒ†ãƒ æ­»æ´»ç›£è¦–
      - alert: SystemDown
        expr: up{job="dental-system"} == 0
        for: 1m
        labels:
          severity: critical
          team: ops
          revolution_impact: high
        annotations:
          summary: "ğŸ”´ ã‚·ã‚¹ãƒ†ãƒ ãƒ€ã‚¦ãƒ³æ¤œçŸ¥"
          description: "æ­¯ç§‘æ¥­ç•Œé©å‘½ã‚·ã‚¹ãƒ†ãƒ ãŒ {{ $value }}åˆ†é–“å¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚"
          runbook_url: "https://wiki.dental-revolution.com/runbooks/system-down"
          
      # é«˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds_bucket{job="dental-system"}) > 0.5
        for: 5m
        labels:
          severity: warning
          team: dev
          revolution_impact: medium
        annotations:
          summary: "âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ åŠ£åŒ–"
          description: "95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ãŒ {{ $value | humanizeDuration }}ã«é”ã—ã¦ã„ã¾ã™ï¼ˆç›®æ¨™: 200msä»¥ä¸‹ï¼‰"
          
      # ã‚¨ãƒ©ãƒ¼ç‡ä¸Šæ˜‡
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="dental-system",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="dental-system"}[5m]))
          ) * 100 > 1
        for: 5m
        labels:
          severity: critical
          team: dev
          revolution_impact: high
        annotations:
          summary: "ğŸ”´ ã‚¨ãƒ©ãƒ¼ç‡ãŒé–¾å€¤ã‚’è¶…é"
          description: "ã‚¨ãƒ©ãƒ¼ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™ï¼ˆé–¾å€¤: 1%ï¼‰"
          
  - name: dental_revolution_performance
    interval: 1m
    rules:
      # CPUä½¿ç”¨ç‡
      - alert: HighCPUUsage
        expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          team: ops
          resource: cpu
        annotations:
          summary: "âš ï¸ CPUä½¿ç”¨ç‡ãŒé«˜ã„"
          description: "CPUä½¿ç”¨ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™"
          
      # ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
          team: ops
          resource: memory
        annotations:
          summary: "âš ï¸ ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒé«˜ã„"
          description: "ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™"
          
      # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 80
        for: 30m
        labels:
          severity: warning
          team: ops
          resource: disk
        annotations:
          summary: "âš ï¸ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒé«˜ã„"
          description: "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™"
          
  - name: dental_revolution_database
    interval: 1m
    rules:
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«æ¯æ¸‡
      - alert: DatabaseConnectionPoolExhausted
        expr: pg_stat_database_numbackends{job="postgresql"} / pg_settings_max_connections{job="postgresql"} > 0.8
        for: 5m
        labels:
          severity: critical
          team: dev
          component: database
        annotations:
          summary: "ğŸ”´ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒæ¯æ¸‡å¯¸å‰"
          description: "æ¥ç¶šãƒ—ãƒ¼ãƒ«ä½¿ç”¨ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™"
          
      # ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒª
      - alert: SlowQueries
        expr: rate(pg_stat_statements_mean_time_seconds{job="postgresql"}[5m]) > 1
        for: 10m
        labels:
          severity: warning
          team: dev
          component: database
        annotations:
          summary: "âš ï¸ ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªæ¤œå‡º"
          description: "å¹³å‡ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ãŒ {{ $value | humanizeDuration }}ã§ã™"
          
      # ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
      - alert: DatabaseDeadlocks
        expr: increase(pg_stat_database_deadlocks{job="postgresql"}[5m]) > 0
        labels:
          severity: critical
          team: dev
          component: database
        annotations:
          summary: "ğŸ”´ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ç™ºç”Ÿ"
          description: "éå»5åˆ†é–“ã« {{ $value }}ä»¶ã®ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          
  - name: dental_revolution_quality
    interval: 5m
    rules:
      # å“è³ªã‚¹ã‚³ã‚¢ä½ä¸‹
      - alert: QualityScoreDegradation
        expr: quality_score{job="dental-system"} < 95
        for: 30m
        labels:
          severity: warning
          team: quality
          revolution_impact: high
        annotations:
          summary: "âš ï¸ å“è³ªã‚¹ã‚³ã‚¢ãŒä½ä¸‹"
          description: "å“è³ªã‚¹ã‚³ã‚¢ãŒ {{ $value }}ç‚¹ã«ä½ä¸‹ã—ã¦ã„ã¾ã™ï¼ˆç›®æ¨™: 95ç‚¹ä»¥ä¸Šï¼‰"
          
      # æ‚£è€…æº€è¶³åº¦ä½ä¸‹
      - alert: PatientSatisfactionDrop
        expr: patient_satisfaction_score{job="dental-system"} < 90
        for: 1h
        labels:
          severity: warning
          team: product
          revolution_impact: medium
        annotations:
          summary: "âš ï¸ æ‚£è€…æº€è¶³åº¦ãŒä½ä¸‹"
          description: "æ‚£è€…æº€è¶³åº¦ãŒ {{ $value }}%ã«ä½ä¸‹ã—ã¦ã„ã¾ã™"
          
      # äºˆç´„ç²¾åº¦ä½ä¸‹
      - alert: AppointmentAccuracyDrop
        expr: appointment_accuracy{job="dental-system"} < 99
        for: 30m
        labels:
          severity: critical
          team: dev
          revolution_impact: high
        annotations:
          summary: "ğŸ”´ äºˆç´„ç²¾åº¦ãŒä½ä¸‹"
          description: "äºˆç´„ç²¾åº¦ãŒ {{ $value }}%ã«ä½ä¸‹ã—ã¦ã„ã¾ã™ï¼ˆé‡è¤‡äºˆç´„ã®å¯èƒ½æ€§ï¼‰"
          
  - name: dental_revolution_security
    interval: 1m
    rules:
      # ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
      - alert: SuspiciousActivity
        expr: rate(failed_login_attempts{job="dental-system"}[5m]) > 10
        labels:
          severity: critical
          team: security
          type: intrusion_attempt
        annotations:
          summary: "ğŸ”´ ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã‚’æ¤œå‡º"
          description: "éå»5åˆ†é–“ã« {{ $value }}å›/ç§’ã®å¤±æ•—ã—ãŸãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ"
          
      # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
      - alert: PotentialSQLInjection
        expr: rate(sql_injection_attempts{job="dental-system"}[5m]) > 0
        labels:
          severity: critical
          team: security
          type: sql_injection
        annotations:
          summary: "ğŸ”´ SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯èƒ½æ€§"
          description: "SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          
      # XSSæ”»æ’ƒæ¤œå‡º
      - alert: PotentialXSSAttack
        expr: rate(xss_attempts{job="dental-system"}[5m]) > 0
        labels:
          severity: critical
          team: security
          type: xss
        annotations:
          summary: "ğŸ”´ XSSæ”»æ’ƒã®å¯èƒ½æ€§"
          description: "XSSãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
          
  - name: dental_revolution_business
    interval: 5m
    rules:
      # äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡ä¸Šæ˜‡
      - alert: HighCancellationRate
        expr: |
          (
            sum(increase(appointment_cancellations{job="dental-system"}[1h]))
            /
            sum(increase(appointment_bookings{job="dental-system"}[1h]))
          ) * 100 > 10
        for: 1h
        labels:
          severity: warning
          team: product
          business_impact: high
        annotations:
          summary: "âš ï¸ äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡ãŒä¸Šæ˜‡"
          description: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡ãŒ {{ $value | humanize }}%ã«é”ã—ã¦ã„ã¾ã™"
          
      # æ¥­å‹™åŠ¹ç‡ä½ä¸‹
      - alert: EfficiencyDegradation
        expr: efficiency_improvement_rate{job="dental-system"} < 200
        for: 2h
        labels:
          severity: warning
          team: product
          revolution_impact: medium
        annotations:
          summary: "âš ï¸ æ¥­å‹™åŠ¹ç‡æ”¹å–„ç‡ãŒä½ä¸‹"
          description: "åŠ¹ç‡æ”¹å–„ç‡ãŒ {{ $value }}%ã«ä½ä¸‹ã—ã¦ã„ã¾ã™ï¼ˆç›®æ¨™: 300%ä»¥ä¸Šï¼‰"

# ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥è¨­å®š
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
            
# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
global:
  # è©•ä¾¡é–“éš”
  evaluation_interval: 30s
  
  # å¤–éƒ¨ãƒ©ãƒ™ãƒ«
  external_labels:
    monitor: 'dental-revolution'
    environment: 'production'
    
# é€šçŸ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'dental-revolution-team'
  
  routes:
    # Critical ã‚¢ãƒ©ãƒ¼ãƒˆã¯å³åº§ã«é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true
      
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã¯å°‚ç”¨ãƒãƒ£ãƒ³ãƒãƒ«
    - match:
        team: security
      receiver: 'security-team'
      
    # ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒé«˜ã„ã‚‚ã®ã¯çµŒå–¶å±¤ã«ã‚‚é€šçŸ¥
    - match:
        business_impact: high
      receiver: 'management-team'

# é€šçŸ¥å…ˆè¨­å®š
receivers:
  - name: 'dental-revolution-team'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dental-revolution-alerts'
        title: 'æ­¯ç§‘æ¥­ç•Œé©å‘½ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ'
        
  - name: 'critical-alerts'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        
  - name: 'security-team'
    email_configs:
      - to: 'security@dental-revolution.com'
        
  - name: 'management-team'
    email_configs:
      - to: 'management@dental-revolution.com'