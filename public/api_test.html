<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APIæ¥ç¶šãƒ†ã‚¹ãƒˆ - æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .status-badge { font-size: 0.8em; padding: 4px 8px; border-radius: 4px; }
    .status-success { background: #28a745; color: white; }
    .status-error { background: #dc3545; color: white; }
    .status-pending { background: #ffc107; color: black; }
    .log-entry { font-family: monospace; font-size: 0.9em; margin: 2px 0; }
    .log-success { color: #28a745; }
    .log-error { color: #dc3545; }
    .log-info { color: #17a2b8; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>ğŸ”§ APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–“ã®é€šä¿¡ã‚’ç¢ºèªã—ã¾ã™</p>

    <!-- æ¥ç¶šçŠ¶æ…‹ -->
    <div class="test-section">
      <h3>æ¥ç¶šçŠ¶æ…‹</h3>
      <div class="row">
        <div class="col-md-4">
          <p>APIæ¥ç¶š: <span id="api-status" class="status-badge status-pending">æœªç¢ºèª</span></p>
        </div>
        <div class="col-md-4">
          <p>èªè¨¼çŠ¶æ…‹: <span id="auth-status" class="status-badge status-pending">æœªèªè¨¼</span></p>
        </div>
        <div class="col-md-4">
          <p>WebSocket: <span id="ws-status" class="status-badge status-pending">æœªæ¥ç¶š</span></p>
        </div>
      </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="test-section">
      <h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
      <div class="row g-2">
        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="testAPIConnection()">
            1. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info w-100" onclick="testCORS()">
            2. CORSè¨­å®šãƒ†ã‚¹ãƒˆ
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" onclick="testAuthentication()">
            3. èªè¨¼ãƒ†ã‚¹ãƒˆ
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-warning w-100" onclick="testWebSocket()">
            4. WebSocketãƒ†ã‚¹ãƒˆ
          </button>
        </div>
      </div>
      <div class="mt-2">
        <button class="btn btn-dark w-100" onclick="runAllTests()">
          ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
      </div>
    </div>

    <!-- èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="test-section">
      <h3>èªè¨¼ãƒ†ã‚¹ãƒˆ</h3>
      <div class="row">
        <div class="col-md-6">
          <input type="email" id="email" class="form-control mb-2" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" value="admin@dental.clinic">
          <input type="password" id="password" class="form-control mb-2" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="password123">
          <button class="btn btn-primary" onclick="performLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn btn-secondary" onclick="performLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div class="col-md-6">
          <h5>ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h5>
          <div id="token-info" class="text-muted">æœªå–å¾—</div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h3>ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</h3>
      <div class="row g-2">
        <div class="col-md-3">
          <button class="btn btn-info w-100" onclick="fetchAppointments()">äºˆç´„ä¸€è¦§</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info w-100" onclick="fetchPatients()">æ‚£è€…ä¸€è¦§</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info w-100" onclick="fetchDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info w-100" onclick="fetchAIPredictions()">AIäºˆæ¸¬</button>
        </div>
      </div>
      <div class="mt-3">
        <h5>å–å¾—ãƒ‡ãƒ¼ã‚¿</h5>
        <pre id="data-result" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">ãƒ‡ãƒ¼ã‚¿æœªå–å¾—</pre>
      </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆãƒ­ã‚° -->
    <div class="test-section">
      <h3>ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h3>
      <div id="test-log" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
        <div class="log-entry log-info">ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™...</div>
      </div>
    </div>
  </div>

  <script src="/api_client.js"></script>
  <script>
    let api = null;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('test-log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(elementId, status, text) {
      const element = document.getElementById(elementId);
      element.className = `status-badge status-${status}`;
      element.textContent = text;
    }

    async function testAPIConnection() {
      log('APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
      try {
        const response = await fetch('http://localhost:3001/health');
        const data = await response.json();
        
        if (data.status === 'OK') {
          updateStatus('api-status', 'success', 'æ¥ç¶šæˆåŠŸ');
          log('APIæ¥ç¶šæˆåŠŸ: ' + JSON.stringify(data), 'success');
        } else {
          throw new Error('ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—');
        }
      } catch (error) {
        updateStatus('api-status', 'error', 'æ¥ç¶šå¤±æ•—');
        log('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function testCORS() {
      log('CORSè¨­å®šãƒ†ã‚¹ãƒˆé–‹å§‹...');
      try {
        const response = await fetch('http://localhost:3001/api/v1/test', {
          method: 'OPTIONS',
          headers: {
            'Origin': window.location.origin,
            'Access-Control-Request-Method': 'GET',
            'Access-Control-Request-Headers': 'Content-Type, Authorization'
          }
        });
        
        const corsHeaders = {
          'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
          'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
          'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
          'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
        };
        
        log('CORSè¨­å®š: ' + JSON.stringify(corsHeaders, null, 2), 'success');
      } catch (error) {
        log('CORSãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function testAuthentication() {
      log('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹...');
      if (!api) {
        api = new DentalClinicAPI('http://localhost:3001');
      }
      
      try {
        const verified = await api.verifyToken();
        if (verified) {
          updateStatus('auth-status', 'success', 'èªè¨¼æ¸ˆã¿');
          log('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼æˆåŠŸ: ' + JSON.stringify(verified), 'success');
        } else {
          updateStatus('auth-status', 'error', 'æœªèªè¨¼');
          log('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼å¤±æ•—', 'error');
        }
      } catch (error) {
        updateStatus('auth-status', 'error', 'èªè¨¼ã‚¨ãƒ©ãƒ¼');
        log('èªè¨¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function testWebSocket() {
      log('WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
      
      if (!api || !api.token) {
        log('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      try {
        api.connectWebSocket();
        
        // æ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
        setTimeout(() => {
          if (api.cable && api.cable.readyState === WebSocket.OPEN) {
            updateStatus('ws-status', 'success', 'æ¥ç¶šæ¸ˆã¿');
            log('WebSocketæ¥ç¶šæˆåŠŸ', 'success');
          } else {
            updateStatus('ws-status', 'error', 'æ¥ç¶šå¤±æ•—');
            log('WebSocketæ¥ç¶šå¤±æ•—', 'error');
          }
        }, 2000);
      } catch (error) {
        updateStatus('ws-status', 'error', 'æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        log('WebSocketã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function performLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${email}`);
      
      if (!api) {
        api = new DentalClinicAPI('http://localhost:3001');
      }
      
      try {
        const result = await api.login(email, password);
        updateStatus('auth-status', 'success', 'èªè¨¼æ¸ˆã¿');
        document.getElementById('token-info').textContent = `Token: ${result.token.substring(0, 20)}...`;
        log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ' + JSON.stringify(result.user), 'success');
        
        // WebSocketè‡ªå‹•æ¥ç¶š
        setTimeout(() => testWebSocket(), 1000);
      } catch (error) {
        updateStatus('auth-status', 'error', 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
        log('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function performLogout() {
      if (!api) return;
      
      log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ...');
      await api.logout();
      updateStatus('auth-status', 'pending', 'æœªèªè¨¼');
      updateStatus('ws-status', 'pending', 'æœªæ¥ç¶š');
      document.getElementById('token-info').textContent = 'æœªå–å¾—';
      log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†', 'success');
    }

    async function fetchAppointments() {
      if (!api || !api.token) {
        log('èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }
      
      try {
        const appointments = await api.getAppointments();
        document.getElementById('data-result').textContent = JSON.stringify(appointments, null, 2);
        log(`äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${appointments.length}ä»¶`, 'success');
      } catch (error) {
        log('äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function fetchPatients() {
      if (!api || !api.token) {
        log('èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }
      
      try {
        const patients = await api.getPatients();
        document.getElementById('data-result').textContent = JSON.stringify(patients, null, 2);
        log(`æ‚£è€…ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${patients.length}ä»¶`, 'success');
      } catch (error) {
        log('æ‚£è€…ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function fetchDashboard() {
      if (!api || !api.token) {
        log('èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }
      
      try {
        const stats = await api.getDashboardStats();
        document.getElementById('data-result').textContent = JSON.stringify(stats, null, 2);
        log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ', 'success');
      } catch (error) {
        log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function fetchAIPredictions() {
      if (!api || !api.token) {
        log('èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }
      
      try {
        const predictions = await api.getAIPredictions('appointments');
        document.getElementById('data-result').textContent = JSON.stringify(predictions, null, 2);
        log('AIäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ', 'success');
      } catch (error) {
        log('AIäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    async function runAllTests() {
      log('===== å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ =====', 'info');
      
      await testAPIConnection();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await testCORS();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await performLogin();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await fetchAppointments();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      log('===== å…¨ãƒ†ã‚¹ãƒˆå®Œäº† =====', 'info');
    }

    // WebSocketã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('notification:received', (event) => {
      log('é€šçŸ¥å—ä¿¡: ' + JSON.stringify(event.detail), 'info');
    });

    window.addEventListener('appointment:updated', (event) => {
      log('äºˆç´„æ›´æ–°: ' + JSON.stringify(event.detail), 'info');
    });

    // åˆæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    window.addEventListener('load', () => {
      testAPIConnection();
    });
  </script>
</body>
</html>