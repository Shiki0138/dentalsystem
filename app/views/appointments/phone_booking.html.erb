<!-- é›»è©±äºˆç´„å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå—ä»˜ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘ï¼‰ -->
<div class="phone-booking-container max-w-4xl mx-auto">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">ğŸ“ é›»è©±äºˆç´„å—ä»˜</h1>
      <p class="text-gray-600 mt-1">æ‚£è€…ã•ã‚“ã‹ã‚‰ã®é›»è©±äºˆç´„ã‚’ç´ æ—©ãç™»éŒ²</p>
    </div>
    <div class="text-sm text-gray-500">
      å—ä»˜æ™‚åˆ»: <%= Time.current.strftime("%H:%M") %>
    </div>
  </div>

  <!-- é›»è©±äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="bg-white rounded-lg shadow p-6">
    <%= form_with model: [@appointment || Appointment.new], 
        url: appointments_path, 
        method: :post,
        local: false,
        data: { turbo_frame: "_top" },
        class: "space-y-6",
        id: "phoneBookingForm" do |form| %>
      
      <!-- äºˆç´„å…ƒè¨­å®š -->
      <%= form.hidden_field :reservation_source_id, value: ReservationSource.find_by(source_type: 'phone')&.id %>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- å·¦ã‚«ãƒ©ãƒ : æ‚£è€…æƒ…å ± -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">ğŸ‘¤ æ‚£è€…æƒ…å ±</h3>
          
          <!-- æ‚£è€…æ¤œç´¢ -->
          <div>
            <%= label_tag :patient_search, "æ‚£è€…æ¤œç´¢", class: "block text-sm font-medium text-gray-700" %>
            <div class="mt-1 relative">
              <%= text_field_tag :patient_search, "", 
                  placeholder: "æ‚£è€…åã¾ãŸã¯é›»è©±ç•ªå·ã‚’å…¥åŠ›", 
                  class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",
                  data: { 
                    controller: "patient-search",
                    action: "input->patient-search#search",
                    patient_search_url_value: search_patients_appointments_path
                  } %>
              
              <!-- æ¤œç´¢çµæœ -->
              <div id="patient-search-results" 
                   class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
              </div>
            </div>
            <%= form.hidden_field :patient_id, id: "selected_patient_id" %>
          </div>
          
          <!-- æ—¢å­˜æ‚£è€…æƒ…å ±è¡¨ç¤º -->
          <div id="selected-patient-info" class="hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
              <h4 class="text-sm font-medium text-blue-900">é¸æŠã•ã‚ŒãŸæ‚£è€…</h4>
              <div id="patient-details" class="mt-2 text-sm text-blue-800">
                <!-- æ‚£è€…è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <button type="button" id="clear-patient" class="mt-2 text-xs text-blue-600 hover:text-blue-800">
                ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
          
          <!-- æ–°è¦æ‚£è€…æƒ…å ±ï¼ˆæ‚£è€…ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰ -->
          <div id="new-patient-form" class="space-y-4">
            <div class="bg-green-50 border border-green-200 rounded-md p-4">
              <h4 class="text-sm font-medium text-green-900 mb-3">ğŸ“ æ–°è¦æ‚£è€…ç™»éŒ²</h4>
              
              <div class="grid grid-cols-1 gap-3">
                <%= text_field_tag "new_patient[name]", "", 
                    placeholder: "æ‚£è€…åï¼ˆå¿…é ˆï¼‰", 
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm" %>
                
                <%= text_field_tag "new_patient[name_kana]", "", 
                    placeholder: "ãƒ•ãƒªã‚¬ãƒŠ", 
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm" %>
                
                <%= telephone_field_tag "new_patient[phone]", "", 
                    placeholder: "é›»è©±ç•ªå·ï¼ˆå¿…é ˆï¼‰", 
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm" %>
                
                <%= email_field_tag "new_patient[email]", "", 
                    placeholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ‰ç”¨ï¼‰", 
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm" %>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ : äºˆç´„æƒ…å ± -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-2">ğŸ“… äºˆç´„æƒ…å ±</h3>
          
          <!-- äºˆç´„æ—¥æ™‚ -->
          <div>
            <%= form.label :appointment_date, "äºˆç´„æ—¥æ™‚", class: "block text-sm font-medium text-gray-700" %>
            <%= form.datetime_local_field :appointment_date, 
                value: 1.day.from_now.strftime("%Y-%m-%dT09:00"),
                min: Date.current.strftime("%Y-%m-%dT09:00"),
                max: 3.months.from_now.strftime("%Y-%m-%dT17:00"),
                class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
          </div>
          
          <!-- æ²»ç™‚å†…å®¹ -->
          <div>
            <%= form.label :treatment_type, "æ²»ç™‚å†…å®¹", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :treatment_type, 
                options_for_select([
                  ['å®šæœŸæ¤œè¨º', 'checkup'],
                  ['ä¸€èˆ¬è¨ºç™‚', 'general'],
                  ['ç›¸è«‡ãƒ»ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°', 'consultation'],
                  ['æ­¯çŸ³é™¤å»ãƒ»ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°', 'cleaning'],
                  ['è™«æ­¯æ²»ç™‚ãƒ»è©°ã‚ç‰©', 'filling'],
                  ['è¢«ã›ç‰©ãƒ»ã‚¯ãƒ©ã‚¦ãƒ³', 'crown'],
                  ['æ ¹ç®¡æ²»ç™‚', 'root_canal'],
                  ['æŠœæ­¯', 'extraction'],
                  ['çŸ¯æ­£æ²»ç™‚', 'orthodontics'],
                  ['ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°', 'whitening'],
                  ['ãã®ä»–', 'other']
                ], 'checkup'),
                {},
                class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
          </div>
          
          <!-- å‚™è€ƒãƒ»è¦æœ› -->
          <div>
            <%= form.label :notes, "å‚™è€ƒãƒ»è¦æœ›", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_area :notes, 
                rows: 3,
                placeholder: "ç—›ã¿ã®çŠ¶æ³ã€å¸Œæœ›æ™‚é–“å¸¯ãªã©...",
                class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
          </div>
          
          <!-- ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®š -->
          <div class="bg-purple-50 border border-purple-200 rounded-md p-4">
            <h4 class="text-sm font-medium text-purple-900 mb-2">ğŸ“§ ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®š</h4>
            <div class="space-y-2">
              <label class="inline-flex items-center">
                <%= check_box_tag "reminder_settings[seven_days]", "1", true, 
                    class: "rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-500 focus:ring-purple-500" %>
                <span class="ml-2 text-sm text-gray-700">7æ—¥å‰ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
              </label>
              <label class="inline-flex items-center">
                <%= check_box_tag "reminder_settings[three_days]", "1", true, 
                    class: "rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-500 focus:ring-purple-500" %>
                <span class="ml-2 text-sm text-gray-700">3æ—¥å‰ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
              </label>
            </div>
            <p class="text-xs text-purple-600 mt-2">
              â€» ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿é€ä¿¡ã•ã‚Œã¾ã™
            </p>
          </div>
        </div>
      </div>
      
      <!-- äºˆç´„å†…å®¹ç¢ºèª -->
      <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
        <h4 class="text-sm font-medium text-gray-900 mb-2">ğŸ“‹ äºˆç´„å†…å®¹ç¢ºèª</h4>
        <div id="booking-summary" class="text-sm text-gray-600">
          äºˆç´„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </div>
      </div>
      
      <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="flex justify-end space-x-3">
        <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", appointments_path, 
            class: "bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
        
        <%= form.submit "äºˆç´„ã‚’ç™»éŒ²", 
            class: "bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
            data: { disable_with: "ç™»éŒ²ä¸­..." } %>
      </div>
    <% end %>
  </div>

  <!-- é›»è©±å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
  <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-md p-4">
    <h3 class="text-sm font-medium text-yellow-900 mb-3">â˜ï¸ é›»è©±å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-yellow-800">
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">æ‚£è€…åãƒ»é€£çµ¡å…ˆã®ç¢ºèª</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">ç—‡çŠ¶ãƒ»è¦æœ›ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">å¸Œæœ›æ—¥æ™‚ã®ç¢ºèª</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">äºˆç´„å†…å®¹ã®å¾©å”±ç¢ºèª</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">æ¥é™¢æ™‚ã®æ³¨æ„äº‹é …èª¬æ˜</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" class="rounded border-yellow-300 text-yellow-600">
        <span class="ml-2">ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šã®èª¬æ˜</span>
      </label>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // äºˆç´„å†…å®¹ã®å‹•çš„æ›´æ–°
  function updateBookingSummary() {
    const patientName = document.getElementById('selected_patient_id').value ? 
                       document.querySelector('#patient-details')?.textContent || 'é¸æŠã•ã‚ŒãŸæ‚£è€…' :
                       document.querySelector('input[name="new_patient[name]"]')?.value || 'æ–°è¦æ‚£è€…';
    
    const appointmentDate = document.getElementById('appointment_appointment_date').value;
    const treatmentType = document.getElementById('appointment_treatment_type').selectedOptions[0]?.text || '';
    
    if (appointmentDate) {
      const date = new Date(appointmentDate);
      const dateStr = date.toLocaleDateString('ja-JP', { 
        year: 'numeric', month: 'long', day: 'numeric', 
        hour: '2-digit', minute: '2-digit' 
      });
      
      document.getElementById('booking-summary').innerHTML = `
        <strong>æ‚£è€…:</strong> ${patientName}<br>
        <strong>æ—¥æ™‚:</strong> ${dateStr}<br>
        <strong>æ²»ç™‚:</strong> ${treatmentType}
      `;
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´æ™‚ã®æ›´æ–°
  document.addEventListener('change', updateBookingSummary);
  document.addEventListener('input', updateBookingSummary);
  
  // æ‚£è€…ã‚¯ãƒªã‚¢æ©Ÿèƒ½
  document.getElementById('clear-patient')?.addEventListener('click', function() {
    document.getElementById('selected_patient_id').value = '';
    document.getElementById('selected-patient-info').classList.add('hidden');
    document.getElementById('new-patient-form').classList.remove('hidden');
    updateBookingSummary();
  });
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ç¢ºèª
  document.getElementById('phoneBookingForm').addEventListener('submit', function(e) {
    const patientId = document.getElementById('selected_patient_id').value;
    const newPatientName = document.querySelector('input[name="new_patient[name]"]')?.value;
    
    if (!patientId && !newPatientName) {
      e.preventDefault();
      alert('æ‚£è€…æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const appointmentDate = document.getElementById('appointment_appointment_date').value;
    if (!appointmentDate) {
      e.preventDefault();
      alert('äºˆç´„æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    // éå»ã®æ—¥æ™‚ãƒã‚§ãƒƒã‚¯
    if (new Date(appointmentDate) < new Date()) {
      e.preventDefault();
      alert('äºˆç´„æ—¥æ™‚ã¯æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
      return;
    }
  });
});
</script>