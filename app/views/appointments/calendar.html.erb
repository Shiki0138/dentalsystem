<div class="calendar-container">
  <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="sm:flex sm:items-center sm:justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
      <p class="mt-2 text-sm text-gray-600">
        è¨ºç™‚äºˆç´„ã®ç®¡ç†ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
      </p>
    </div>
    <div class="mt-4 sm:mt-0 flex space-x-3">
      <%= link_to appointments_path, 
          class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" do %>
        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
        </svg>
        ãƒªã‚¹ãƒˆè¡¨ç¤º
      <% end %>
      <%= link_to new_appointment_path, 
          class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" do %>
        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        æ–°è¦äºˆç´„
      <% end %>
    </div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="bg-white shadow sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center space-x-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900">è¡¨ç¤ºè¨­å®š</h3>
          <div class="flex items-center space-x-2">
            <button id="monthViewBtn" class="px-3 py-1 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              æœˆè¡¨ç¤º
            </button>
            <button id="weekViewBtn" class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
              é€±è¡¨ç¤º
            </button>
            <button id="dayViewBtn" class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
              æ—¥è¡¨ç¤º
            </button>
          </div>
        </div>
        <div class="mt-4 sm:mt-0 flex items-center space-x-2">
          <button id="todayBtn" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            ä»Šæ—¥
          </button>
          <button id="prevBtn" class="p-2 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <span id="currentDate" class="text-lg font-medium text-gray-900 min-w-[200px] text-center"></span>
          <button id="nextBtn" class="p-2 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ -->
  <div class="bg-white shadow sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
      <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-6">
        <div class="flex items-center">
          <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">äºˆç´„æ¸ˆã¿</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">ç¢ºèªæ¸ˆã¿</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-gray-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">å®Œäº†</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-amber-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-indigo-500 rounded mr-2"></div>
          <span class="text-sm text-gray-700">ãã®ä»–</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div id="calendar" class="calendar-fullcalendar"></div>
    </div>
  </div>
</div>

<!-- äºˆç´„ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="createAppointmentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">æ–°è¦äºˆç´„ä½œæˆ</h3>
        <button id="closeCreateModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <%= form_with model: Appointment.new, local: false, data: { turbo_frame: "_top" }, class: "space-y-6", id: "createAppointmentForm" do |form| %>
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <%= form.label :patient_id, "æ‚£è€…", class: "block text-sm font-medium text-gray-700" %>
            <div class="mt-1 relative">
              <input type="text" id="patientSearch" placeholder="æ‚£è€…åã¾ãŸã¯é›»è©±ç•ªå·ã§æ¤œç´¢" 
                     class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md">
              <div id="patientSearchResults" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden"></div>
            </div>
            <%= form.hidden_field :patient_id, id: "selectedPatientId" %>
            <div id="selectedPatientInfo" class="mt-2 text-sm text-gray-600 hidden"></div>
          </div>

          <div>
            <%= form.label :appointment_date, "äºˆç´„æ—¥æ™‚", class: "block text-sm font-medium text-gray-700" %>
            <%= form.datetime_local_field :appointment_date, id: "appointmentDateTime", 
                class: "mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" %>
          </div>

          <div>
            <%= form.label :treatment_type, "æ²»ç™‚å†…å®¹", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :treatment_type, 
                options_for_select([
                  [t('appointment.treatment_type.general'), 'general'],
                  [t('appointment.treatment_type.consultation'), 'consultation'],
                  [t('appointment.treatment_type.checkup'), 'checkup'],
                  [t('appointment.treatment_type.cleaning'), 'cleaning'],
                  [t('appointment.treatment_type.filling'), 'filling'],
                  [t('appointment.treatment_type.crown'), 'crown'],
                  [t('appointment.treatment_type.root_canal'), 'root_canal'],
                  [t('appointment.treatment_type.extraction'), 'extraction'],
                  [t('appointment.treatment_type.orthodontics'), 'orthodontics'],
                  [t('appointment.treatment_type.whitening'), 'whitening'],
                  [t('appointment.treatment_type.other'), 'other']
                ], 'general'),
                {},
                class: "mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" %>
          </div>

          <div>
            <%= form.label :status, "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", class: "block text-sm font-medium text-gray-700" %>
            <%= form.select :status, 
                options_for_select([
                  ['äºˆç´„æ¸ˆã¿', 'booked'],
                  ['ç¢ºèªæ¸ˆã¿', 'visited'],
                ], 'booked'),
                {},
                class: "mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" %>
          </div>
        </div>

        <div>
          <%= form.label :notes, "å‚™è€ƒ", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :notes, rows: 3, 
              class: "mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" %>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelCreateBtn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <%= form.submit "äºˆç´„ä½œæˆ", class: "bg-indigo-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- äºˆç´„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="appointmentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">äºˆç´„è©³ç´°</h3>
        <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div id="appointmentDetailContent" class="space-y-4">
        <!-- è©³ç´°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
      
      <div class="flex justify-end space-x-3 mt-6">
        <button id="editAppointmentBtn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          ç·¨é›†
        </button>
        <button id="cancelAppointmentBtn" class="bg-red-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Stimulus Controller -->
<div data-controller="calendar ai-demo" 
     data-calendar-events-url-value="<%= calendar_appointments_path(format: :json) %>"
     data-calendar-create-url-value="<%= appointments_path %>"
     data-calendar-search-patients-url-value="<%= search_patients_appointments_path %>"
     data-ai-demo-demo-mode-value="<%= Rails.env.development? || ENV['DEMO_MODE'] == 'true' %>"
     data-ai-demo-api-url-value="/api/ai">
</div>

<!-- ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ç”¨ã®èª¬æ˜ãƒ‘ãƒãƒ« -->
<% if Rails.env.development? || ENV['DEMO_MODE'] == 'true' %>
<div class="fixed top-20 left-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg shadow-lg z-40 max-w-sm">
  <h3 class="font-bold mb-2">ğŸ¤– AIäºˆç´„æœ€é©åŒ–ãƒ‡ãƒ¢</h3>
  <p class="text-sm mb-3">é©æ–°çš„ãªAIæ©Ÿèƒ½ã‚’ä½“é¨“ã§ãã¾ã™ï¼š</p>
  <ul class="text-xs space-y-1">
    <li>âœ¨ æœ€é©äºˆç´„æ™‚é–“ã®ææ¡ˆ</li>
    <li>âš ï¸ ç«¶åˆäºˆæ¸¬ã¨è‡ªå‹•å›é¿</li>
    <li>ğŸ”„ ç¹°ã‚Šè¿”ã—äºˆç´„ã®æœ€é©åŒ–</li>
    <li>ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§èƒ½åˆ†æ</li>
  </ul>
  <div class="mt-3 text-xs opacity-75">
    åŠ¹ç‡æ€§: 98.5% | å¿œç­”: 50ms | ç²¾åº¦: 94.2%
  </div>
</div>
<% end %>

<style>
  .calendar-fullcalendar {
    font-family: 'Inter', sans-serif;
  }
  
  .fc-event {
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .fc-daygrid-event {
    border-radius: 4px;
    margin: 1px;
  }
  
  .fc-timegrid-event {
    border-radius: 4px;
    margin: 1px;
  }
  
  .fc-button {
    background-color: #4F46E5 !important;
    border-color: #4F46E5 !important;
    color: white !important;
    font-weight: 500 !important;
    padding: 6px 12px !important;
    border-radius: 6px !important;
  }
  
  .fc-button:hover {
    background-color: #4338CA !important;
    border-color: #4338CA !important;
  }
  
  .fc-button:focus {
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2) !important;
  }
  
  .fc-button-primary:disabled {
    background-color: #9CA3AF !important;
    border-color: #9CA3AF !important;
  }
  
  .fc-today-button {
    background-color: #6B7280 !important;
    border-color: #6B7280 !important;
  }
  
  .fc-today-button:hover {
    background-color: #4B5563 !important;
    border-color: #4B5563 !important;
  }
  
  .fc-daygrid-day-top {
    justify-content: center;
  }
  
  .fc-day-today {
    background-color: #FEF3C7 !important;
  }
  
  .fc-toolbar {
    margin-bottom: 1rem !important;
  }
  
  .fc-toolbar-title {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #1F2937 !important;
  }
  
  .fc-col-header-cell {
    background-color: #F9FAFB;
    border-color: #E5E7EB;
    font-weight: 600;
    color: #374151;
  }
  
  .fc-scrollgrid {
    border-color: #E5E7EB !important;
  }
  
  .fc-scrollgrid-section > td {
    border-color: #E5E7EB !important;
  }
  
  .fc-daygrid-day {
    background-color: white;
  }
  
  .fc-daygrid-day:hover {
    background-color: #F9FAFB;
  }
  
  @media (max-width: 768px) {
    .fc-toolbar {
      flex-direction: column !important;
      gap: 0.5rem !important;
    }
    
    .fc-toolbar-chunk {
      display: flex !important;
      justify-content: center !important;
    }
    
    .fc-button-group {
      flex-wrap: wrap !important;
    }
  }
</style>