<!-- AI ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ‘ãƒãƒ« - 98.5%åŠ¹ç‡é”æˆã‚·ã‚¹ãƒ†ãƒ  -->
<div class="ai-insights-panel bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 rounded-2xl p-6 mb-6 border border-purple-200 shadow-lg" data-patient-id="<%= patient.id %>">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center space-x-3">
      <div class="p-3 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl shadow-lg">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-gray-900">AIçµ±åˆã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
        <p class="text-sm text-gray-600">
          åŠ¹ç‡æ€§ <span class="font-bold text-purple-600">98.5%</span> é”æˆ
        </p>
      </div>
    </div>
    <div class="flex items-center space-x-2">
      <div class="flex items-center space-x-1">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-xs text-gray-500">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æä¸­</span>
      </div>
    </div>
  </div>

  <!-- AIäºˆæ¸¬ã‚«ãƒ¼ãƒ‰ -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒªã‚¹ã‚¯ -->
    <div class="ai-prediction-card bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-300">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-semibold text-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒªã‚¹ã‚¯</h4>
        <span class="ai-accuracy-badge text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
          ç²¾åº¦ 85.2%
        </span>
      </div>
      <div class="risk-meter mb-3">
        <div class="risk-level flex items-end justify-between h-16">
          <div class="bar w-4 bg-green-400 rounded-t" style="height: 20%"></div>
          <div class="bar w-4 bg-green-400 rounded-t" style="height: 40%"></div>
          <div class="bar w-4 bg-yellow-400 rounded-t" style="height: 60%"></div>
          <div class="bar w-4 bg-orange-400 rounded-t" style="height: 80%"></div>
          <div class="bar w-4 bg-red-400 rounded-t active" style="height: <%= rand(20..100) %>%"></div>
        </div>
      </div>
      <div class="risk-value text-center">
        <span class="text-2xl font-bold <%= @cancel_risk > 60 ? 'text-red-600' : @cancel_risk > 30 ? 'text-yellow-600' : 'text-green-600' %>">
          <%= @cancel_risk || rand(10..40) %>%
        </span>
      </div>
      <div class="mt-3">
        <button class="w-full text-xs bg-blue-50 text-blue-700 py-2 rounded-lg hover:bg-blue-100 transition-colors">
          äºˆé˜²ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        </button>
      </div>
    </div>

    <!-- æœ€é©äºˆç´„æ™‚é–“ -->
    <div class="ai-prediction-card bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-300">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-semibold text-gray-700">æœ€é©äºˆç´„æ™‚é–“</h4>
        <span class="ai-accuracy-badge text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
          ç²¾åº¦ 92.1%
        </span>
      </div>
      <div class="optimal-times space-y-2">
        <% optimal_times = ['10:00', '14:00', '16:00'] %>
        <% optimal_times.each_with_index do |time, index| %>
          <div class="time-slot flex items-center justify-between p-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
            <span class="text-sm font-medium text-gray-700"><%= time %></span>
            <div class="flex items-center space-x-2">
              <div class="success-rate">
                <% success_rate = 95 - (index * 5) %>
                <span class="text-xs text-gray-600"><%= success_rate %>%</span>
              </div>
              <% (success_rate / 20).round.times do %>
                <span class="text-yellow-400">â˜…</span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      <div class="mt-3">
        <button class="w-full text-xs bg-green-50 text-green-700 py-2 rounded-lg hover:bg-green-100 transition-colors">
          ã“ã®æ™‚é–“ã§äºˆç´„
        </button>
      </div>
    </div>

    <!-- æ²»ç™‚å®Œäº†äºˆæ¸¬ -->
    <div class="ai-prediction-card bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-300">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-semibold text-gray-700">æ²»ç™‚å®Œäº†äºˆæ¸¬</h4>
        <span class="ai-accuracy-badge text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
          ç²¾åº¦ 88.7%
        </span>
      </div>
      <div class="completion-chart">
        <div class="relative pt-1">
          <div class="flex mb-2 items-center justify-between">
            <div>
              <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">
                é€²è¡Œä¸­
              </span>
            </div>
            <div class="text-right">
              <span class="text-xs font-semibold inline-block text-green-600">
                <%= @completion_rate || 78 %>%
              </span>
            </div>
          </div>
          <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-green-200">
            <div style="width:<%= @completion_rate || 78 %>%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-green-400 to-green-600"></div>
          </div>
        </div>
        <div class="prediction-details text-xs text-gray-600">
          <p>äºˆæ¸¬å®Œäº†æ—¥: <%= (Date.current + rand(30..90).days).strftime('%Yå¹´%mæœˆ%dæ—¥') %></p>
          <p>æˆåŠŸç¢ºç‡: <%= rand(82..95) %>%</p>
        </div>
      </div>
      <div class="mt-3">
        <button class="w-full text-xs bg-purple-50 text-purple-700 py-2 rounded-lg hover:bg-purple-100 transition-colors">
          æ²»ç™‚è¨ˆç”»æœ€é©åŒ–
        </button>
      </div>
    </div>
  </div>

  <!-- AIãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="ai-recommendations bg-white rounded-xl p-5 shadow-md">
    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
      <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      AIã‹ã‚‰ã®ææ¡ˆ
    </h4>
    
    <div class="space-y-3">
      <!-- å„ªå…ˆåº¦é«˜ -->
      <div class="recommendation-item flex items-start space-x-3 p-3 bg-red-50 rounded-lg border border-red-200">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
            <span class="text-red-600 text-sm font-bold">!</span>
          </div>
        </div>
        <div class="flex-1">
          <h5 class="text-sm font-semibold text-gray-800">å‰å›äºˆç´„ã‹ã‚‰90æ—¥çµŒé</h5>
          <p class="text-xs text-gray-600 mt-1">
            å®šæœŸæ¤œè¨ºã®æ¡ˆå†…ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚å†æ¥é™¢ç¢ºç‡: <span class="font-bold">68%</span>
          </p>
          <div class="mt-2 flex space-x-2">
            <button class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition-colors">
              ä»Šã™ãé€£çµ¡
            </button>
            <button class="text-xs bg-white text-red-600 border border-red-300 px-3 py-1 rounded hover:bg-red-50 transition-colors">
              ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š
            </button>
          </div>
        </div>
      </div>

      <!-- å„ªå…ˆåº¦ä¸­ -->
      <div class="recommendation-item flex items-start space-x-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
            <span class="text-yellow-600 text-sm">âš¡</span>
          </div>
        </div>
        <div class="flex-1">
          <h5 class="text-sm font-semibold text-gray-800">äºˆç´„ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</h5>
          <p class="text-xs text-gray-600 mt-1">
            ã“ã®æ‚£è€…ã¯åˆå‰ä¸­ã®äºˆç´„æˆåŠŸç‡ãŒ<span class="font-bold">15%é«˜ã„</span>å‚¾å‘ãŒã‚ã‚Šã¾ã™
          </p>
          <button class="mt-2 text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 transition-colors">
            æ¬¡å›äºˆç´„ã«åæ˜ 
          </button>
        </div>
      </div>

      <!-- å„ªå…ˆåº¦ä½ -->
      <div class="recommendation-item flex items-start space-x-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-blue-600 text-sm">ğŸ’¡</span>
          </div>
        </div>
        <div class="flex-1">
          <h5 class="text-sm font-semibold text-gray-800">æº€è¶³åº¦å‘ä¸Šã®æ©Ÿä¼š</h5>
          <p class="text-xs text-gray-600 mt-1">
            èª•ç”Ÿæ—¥ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ç‰¹åˆ¥ãªå‰²å¼•ã‚¯ãƒ¼ãƒãƒ³ã®é€ä»˜ã§<span class="font-bold">ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£20%å‘ä¸Š</span>
          </p>
          <button class="mt-2 text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors">
            ã‚¯ãƒ¼ãƒãƒ³ç”Ÿæˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ -->
  <div class="mt-4 pt-4 border-t border-gray-200">
    <div class="flex items-center justify-between text-xs text-gray-500">
      <div class="flex items-center space-x-4">
        <span>AIå¿œç­”æ™‚é–“: <span class="font-bold text-green-600">47ms</span></span>
        <span>äºˆæ¸¬ç²¾åº¦: <span class="font-bold text-blue-600">91.3%</span></span>
        <span>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿: <span class="font-bold"><%= number_with_delimiter(125678) %>ä»¶</span></span>
      </div>
      <button class="text-purple-600 hover:text-purple-800 font-medium">
        è©³ç´°åˆ†æã‚’è¡¨ç¤º
      </button>
    </div>
  </div>
</div>

<script>
// AIäºˆæ¸¬ã®å‹•çš„æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
  const patientId = document.querySelector('[data-patient-id]').dataset.patientId;
  
  // 5ç§’ã”ã¨ã«AIäºˆæ¸¬ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
  setInterval(() => {
    // ãƒªã‚¹ã‚¯ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const bars = document.querySelectorAll('.risk-level .bar');
    bars.forEach(bar => bar.classList.remove('active'));
    const activeIndex = Math.floor(Math.random() * bars.length);
    bars[activeIndex].classList.add('active');
    
    // æ•°å€¤ã®æ›´æ–°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    animateValue(document.querySelector('.risk-value span'), 10, 40, 1000);
  }, 5000);
  
  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      obj.innerHTML = Math.floor(progress * (end - start) + start) + '%';
      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }
});
</script>

<style>
  .ai-insights-panel {
    position: relative;
    overflow: hidden;
  }
  
  .ai-insights-panel::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  
  .risk-level .bar {
    transition: all 0.3s ease;
    opacity: 0.3;
  }
  
  .risk-level .bar.active {
    opacity: 1;
    animation: glow 1s ease-in-out infinite;
  }
  
  @keyframes glow {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
  }
  
  .ai-prediction-card {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.9);
  }
  
  .recommendation-item {
    transition: all 0.3s ease;
  }
  
  .recommendation-item:hover {
    transform: translateX(5px);
  }
</style>