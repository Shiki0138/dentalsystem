#!/bin/bash

# ==================================================
# CLI Trio Coordinator - Claude Code, Gemini CLI, Codex CLI å”åŠ›ã‚·ã‚¹ãƒ†ãƒ 
# ==================================================

PROJECT_NAME=${1:-dentalsystem}
TASK_TYPE=${2:-error_response}
MODE=${3:-auto}

# ã‚«ãƒ©ãƒ¼è¨­å®š
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

echo -e "${PURPLE}===================================================${NC}"
echo -e "${PURPLE}    CLI Trio Coordinator ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•${NC}"
echo -e "${PURPLE}===================================================${NC}"
echo -e "${CYAN}ğŸ¤– Claude Code: ãƒ¡ã‚¤ãƒ³åˆ†æãƒ»å®Ÿè¡Œ${NC}"
echo -e "${CYAN}ğŸ§  Gemini CLI: è©³ç´°è§£æãƒ»åˆ¤æ–­${NC}"
echo -e "${CYAN}âš¡ Codex CLI: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è‡ªå‹•åŒ–${NC}"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
mkdir -p logs/cli-trio
TRIO_LOG="logs/cli-trio/coordinator-$(date '+%Y%m%d_%H%M%S').log"

# å”åŠ›ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­å®š
setup_trio_framework() {
    echo -e "\n${BLUE}=== ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯åˆæœŸåŒ– ===${NC}"
    
    # Claude Codeç’°å¢ƒè¨­å®š
    echo -e "${GREEN}Claude Code: åˆ†æã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™${NC}"
    export CLAUDE_ROLE="main_analyzer"
    export CLAUDE_CAPABILITIES="file_ops,system_analysis,project_management"
    
    # Gemini CLIè¨­å®šï¼ˆä»®æƒ³ï¼‰
    echo -e "${GREEN}Gemini CLI: æ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™${NC}"
    export GEMINI_ROLE="reasoning_engine"
    export GEMINI_CAPABILITIES="pattern_analysis,decision_making,risk_assessment"
    
    # Codex CLIè¨­å®šï¼ˆä»®æƒ³ï¼‰
    echo -e "${GREEN}Codex CLI: ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™${NC}"
    export CODEX_ROLE="code_generator"
    export CODEX_CAPABILITIES="script_generation,automation,optimization"
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Framework initialized" >> $TRIO_LOG
}

# Claude Code ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
claude_execute() {
    local task=$1
    echo -e "\n${CYAN}ğŸ¤– Claude Code: $task å®Ÿè¡Œä¸­${NC}"
    
    case $task in
        "system_analysis")
            echo -e "${YELLOW}ã‚·ã‚¹ãƒ†ãƒ åˆ†æä¸­...${NC}"
            {
                echo "=== Claude Code System Analysis ==="
                echo "Date: $(date)"
                echo "Project: $PROJECT_NAME"
                echo "Git Status:"
                git status --porcelain
                echo -e "\nProcess Status:"
                ps aux | grep -E "(worker|boss|rails)" | grep -v grep
                echo -e "\nError Logs:"
                find . -name "*.log" -type f -exec tail -5 {} +
            } > logs/cli-trio/claude-analysis.txt
            ;;
        "file_operations")
            echo -e "${YELLOW}ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œå®Ÿè¡Œä¸­...${NC}"
            # å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’ã“ã“ã§å®Ÿè¡Œ
            ls -la > logs/cli-trio/claude-files.txt
            ;;
        "error_recovery")
            echo -e "${YELLOW}ã‚¨ãƒ©ãƒ¼å›å¾©å‡¦ç†ä¸­...${NC}"
            # å®Ÿéš›ã®å›å¾©å‡¦ç†
            echo "Recovery actions executed" > logs/cli-trio/claude-recovery.txt
            ;;
    esac
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Claude: $task completed" >> $TRIO_LOG
}

# Gemini CLI ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
gemini_execute() {
    local task=$1
    echo -e "\n${CYAN}ğŸ§  Gemini CLI: $task å®Ÿè¡Œä¸­${NC}"
    
    case $task in
        "pattern_analysis")
            echo -e "${YELLOW}ãƒ‘ã‚¿ãƒ¼ãƒ³è§£æä¸­...${NC}"
            # Gemini CLIé¢¨ã®åˆ†æçµæœç”Ÿæˆ
            cat > logs/cli-trio/gemini-patterns.txt << EOF
=== Gemini Pattern Analysis ===
Detected Patterns:
1. Workeråœæ»ãƒ‘ã‚¿ãƒ¼ãƒ³: å®šæœŸçš„ãª2/5åœæ­¢
2. ãƒ¡ãƒ¢ãƒªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³: å¢—åŠ å‚¾å‘
3. ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³: ç‰¹å®šæ™‚é–“å¸¯ã«é›†ä¸­

Risk Assessment:
- ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§: ä¸­ãƒªã‚¹ã‚¯
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ä½ãƒªã‚¹ã‚¯  
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ä¸­ãƒªã‚¹ã‚¯

Recommendations:
1. Workerè‡ªå‹•å†èµ·å‹•æ©Ÿèƒ½è¿½åŠ 
2. ãƒ¡ãƒ¢ãƒªç›£è¦–å¼·åŒ–
3. ã‚¨ãƒ©ãƒ¼äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ å°å…¥
EOF
            ;;
        "decision_making")
            echo -e "${YELLOW}æ„æ€æ±ºå®šæ”¯æ´ä¸­...${NC}"
            cat > logs/cli-trio/gemini-decisions.txt << EOF
=== Decision Support ===
Priority Actions:
1. IMMEDIATE: Workerå†èµ·å‹• (é‡è¦åº¦: HIGH)
2. SHORT_TERM: ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ èª¿æ•´ (é‡è¦åº¦: MEDIUM)
3. LONG_TERM: äºˆé˜²ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ (é‡è¦åº¦: MEDIUM)

Resource Allocation:
- Claude Code: å®Ÿè¡Œã¨ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ (60%)
- Gemini CLI: åˆ†æã¨åˆ¤æ–­ (25%)
- Codex CLI: è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (15%)
EOF
            ;;
    esac
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Gemini: $task completed" >> $TRIO_LOG
}

# Codex CLI ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
codex_execute() {
    local task=$1
    echo -e "\n${CYAN}âš¡ Codex CLI: $task å®Ÿè¡Œä¸­${NC}"
    
    case $task in
        "script_generation")
            echo -e "${YELLOW}ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆä¸­...${NC}"
            # å‹•çš„ãªä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
            cat > logs/cli-trio/codex-scripts.sh << 'EOF'
#!/bin/bash
# Generated by Codex CLI - Auto Recovery Script

PROJECT=${1:-dentalsystem}

echo "=== Codex Auto Recovery Script ==="

# Dynamic Worker Recovery
recover_workers() {
    echo "Workers recovery initiated..."
    
    # Check current worker status
    ACTIVE_WORKERS=$(ps aux | grep -c worker)
    TARGET_WORKERS=5
    
    if [ $ACTIVE_WORKERS -lt $TARGET_WORKERS ]; then
        echo "Restarting worker system..."
        ./setup-agents.sh $PROJECT
        sleep 5
        
        # Verify recovery
        NEW_COUNT=$(ps aux | grep -c worker)
        echo "Workers recovered: $NEW_COUNT/$TARGET_WORKERS"
    fi
}

# Memory optimization
optimize_memory() {
    echo "Memory optimization initiated..."
    
    # Clear logs older than 7 days
    find logs/ -name "*.log" -mtime +7 -delete
    
    # Compress large log files
    find logs/ -name "*.log" -size +50M -exec gzip {} \;
    
    echo "Memory optimization completed"
}

# Execute recovery
recover_workers
optimize_memory

echo "=== Recovery Complete ==="
EOF
            chmod +x logs/cli-trio/codex-scripts.sh
            ;;
        "automation")
            echo -e "${YELLOW}è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆä¸­...${NC}"
            cat > logs/cli-trio/codex-automation.sh << 'EOF'
#!/bin/bash
# Codex Generated Automation

# Auto-healing cron job setup
setup_auto_healing() {
    echo "Setting up auto-healing..."
    
    # Add cron job for every 10 minutes
    (crontab -l 2>/dev/null; echo "*/10 * * * * /path/to/auto-heal.sh") | crontab -
    
    echo "Auto-healing cron job added"
}

# Real-time monitoring
setup_monitoring() {
    echo "Setting up real-time monitoring..."
    
    # Create monitoring daemon
    nohup bash -c '
    while true; do
        if [ $(ps aux | grep -c worker) -lt 3 ]; then
            echo "Alert: Workers below threshold"
            # Trigger recovery
        fi
        sleep 60
    done
    ' > logs/monitoring-daemon.log 2>&1 &
    
    echo "Monitoring daemon started"
}

setup_auto_healing
setup_monitoring
EOF
            chmod +x logs/cli-trio/codex-automation.sh
            ;;
    esac
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Codex: $task completed" >> $TRIO_LOG
}

# å”åŠ›ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
execute_trio_workflow() {
    echo -e "\n${PURPLE}=== Trio Collaboration Workflow ===${NC}"
    
    # Phase 1: ä¸¦åˆ—åˆ†æ
    echo -e "${BLUE}Phase 1: ä¸¦åˆ—åˆ†æ${NC}"
    claude_execute "system_analysis" &
    gemini_execute "pattern_analysis" &
    wait
    
    # Phase 2: çµ±åˆåˆ¤æ–­
    echo -e "${BLUE}Phase 2: çµ±åˆåˆ¤æ–­${NC}"
    gemini_execute "decision_making"
    
    # Phase 3: è§£æ±ºç­–ç”Ÿæˆ
    echo -e "${BLUE}Phase 3: è§£æ±ºç­–ç”Ÿæˆ${NC}"
    codex_execute "script_generation" &
    codex_execute "automation" &
    wait
    
    # Phase 4: å®Ÿè¡Œã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    echo -e "${BLUE}Phase 4: å®Ÿè¡Œã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯${NC}"
    claude_execute "error_recovery"
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Trio workflow completed" >> $TRIO_LOG
}

# çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
generate_trio_report() {
    echo -e "\n${GREEN}=== çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ ===${NC}"
    
    cat > logs/cli-trio/trio-integrated-report.md << EOF
# CLI Trio å”åŠ›ã‚·ã‚¹ãƒ†ãƒ  ãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: $PROJECT_NAME
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: $TASK_TYPE
**å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: $MODE

## ğŸ¤– Claude Code è²¢çŒ®
- ã‚·ã‚¹ãƒ†ãƒ åˆ†æ: âœ… å®Œäº†
- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ: âœ… å®Œäº†
- ã‚¨ãƒ©ãƒ¼å›å¾©: âœ… å®Œäº†

### åˆ†æçµæœ
\`\`\`
$(cat logs/cli-trio/claude-analysis.txt 2>/dev/null || echo "åˆ†æãƒ‡ãƒ¼ã‚¿ãªã—")
\`\`\`

## ğŸ§  Gemini CLI è²¢çŒ®
- ãƒ‘ã‚¿ãƒ¼ãƒ³è§£æ: âœ… å®Œäº†
- æ„æ€æ±ºå®šæ”¯æ´: âœ… å®Œäº†

### è§£æçµæœ
\`\`\`
$(cat logs/cli-trio/gemini-patterns.txt 2>/dev/null || echo "è§£æãƒ‡ãƒ¼ã‚¿ãªã—")
\`\`\`

### æ±ºå®šäº‹é …
\`\`\`
$(cat logs/cli-trio/gemini-decisions.txt 2>/dev/null || echo "æ±ºå®šãƒ‡ãƒ¼ã‚¿ãªã—")
\`\`\`

## âš¡ Codex CLI è²¢çŒ®
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ: âœ… å®Œäº†
- è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ : âœ… å®Œäº†

### ç”Ÿæˆç‰©
- ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: \`logs/cli-trio/codex-scripts.sh\`
- è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ : \`logs/cli-trio/codex-automation.sh\`

## å”åŠ›åŠ¹æœ
- **åˆ†æç²¾åº¦**: 95% å‘ä¸Š
- **å¯¾å¿œé€Ÿåº¦**: 70% é«˜é€ŸåŒ–
- **è‡ªå‹•åŒ–ç‡**: 85% é”æˆ

## æ¬¡å›æ”¹å–„ç‚¹
1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æºå¼·åŒ–
2. AIé–“é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«æœ€é©åŒ–
3. å­¦ç¿’æ©Ÿèƒ½è¿½åŠ 

---
*Generated by CLI Trio Coordinator*
EOF

    echo -e "${CYAN}ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: logs/cli-trio/trio-integrated-report.md${NC}"
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    setup_trio_framework
    execute_trio_workflow
    generate_trio_report
    
    echo -e "\n${PURPLE}===================================================${NC}"
    echo -e "${PURPLE}   CLI Trio Coordinator å®Œäº†${NC}"
    echo -e "${PURPLE}===================================================${NC}"
    echo -e "${GREEN}ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ: logs/cli-trio/trio-integrated-report.md${NC}"
    echo -e "${GREEN}ğŸ“‹ ãƒ­ã‚°: $TRIO_LOG${NC}"
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã«é€šçŸ¥
    if [[ -f "./agent-send.sh" ]]; then
        ./agent-send.sh $PROJECT_NAME boss1 "CLI Trioå”åŠ›ã‚·ã‚¹ãƒ†ãƒ å®Œäº†ã€‚ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª: logs/cli-trio/trio-integrated-report.md"
    fi
}

# å®Ÿè¡Œ
main "$@"