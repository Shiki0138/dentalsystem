#!/bin/bash
# ðŸ”§ æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ­´å²çš„æˆåŠŸã‚·ã‚¹ãƒ†ãƒ ã®ç¶™ç¶šçš„å“è³ªç¶­æŒ

set -e

echo "ðŸ”§ æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  - æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–‹å§‹"
echo "å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=============================================="

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p log maintenance/reports backup

# 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "1ï¸âƒ£ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
HEALTH_STATUS="OK"

# Ruby/Railsç’°å¢ƒç¢ºèª
if ! ruby -v > /dev/null 2>&1; then
    echo "âŒ Rubyç’°å¢ƒã‚¨ãƒ©ãƒ¼"
    HEALTH_STATUS="ERROR"
else
    echo "âœ… Rubyç’°å¢ƒæ­£å¸¸"
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šç¢ºèª
if [ -f "db/development.sqlite3" ]; then
    echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª"
else
    echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æœªä½œæˆ"
fi

# 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–
echo ""
echo "2ï¸âƒ£ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–..."

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
DISK_USAGE=$(df -h . | awk 'NR==2 {print $5}' | sed 's/%//')
echo "ðŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŽ‡: ${DISK_USAGE}%"

if [ "$DISK_USAGE" -gt 80 ]; then
    echo "âš ï¸ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŽ‡ãŒé«˜ããªã£ã¦ã„ã¾ã™"
fi

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
if command -v free > /dev/null; then
    echo "ðŸ§  ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŠ¶æ³:"
    free -h
elif command -v vm_stat > /dev/null; then
    echo "ðŸ§  ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŠ¶æ³ (macOS):"
    vm_stat | head -5
fi

# 3. ãƒ­ã‚°åˆ†æž
echo ""
echo "3ï¸âƒ£ ãƒ­ã‚°åˆ†æžãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
touch log/development.log log/production.log log/error.log

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
ERROR_COUNT=$(grep -c "ERROR\|FATAL" log/*.log 2>/dev/null || echo "0")
echo "ðŸš¨ ã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}ä»¶"

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ7æ—¥ä»¥ä¸Šå¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼‰
find log/ -name "*.log.*" -mtime +7 -delete 2>/dev/null || true
echo "ðŸ—‚ï¸ å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# 4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo ""
echo "4ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ..."

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)

# SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [ -f "db/development.sqlite3" ]; then
    cp db/development.sqlite3 "backup/development_${BACKUP_DATE}.sqlite3"
    echo "âœ… é–‹ç™ºDBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†"
fi

if [ -f "db/production.sqlite3" ]; then
    cp db/production.sqlite3 "backup/production_${BACKUP_DATE}.sqlite3"
    echo "âœ… æœ¬ç•ªDBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†"
fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
tar -czf "backup/config_${BACKUP_DATE}.tar.gz" config/ 2>/dev/null || echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚­ãƒƒãƒ—"

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
find backup/ -name "*.sqlite3" -mtime +30 -delete 2>/dev/null || true
find backup/ -name "*.tar.gz" -mtime +30 -delete 2>/dev/null || true

# 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
echo ""
echo "5ï¸âƒ£ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯..."

# æ¨©é™ãƒã‚§ãƒƒã‚¯
SENSITIVE_FILES=("config/database.yml" "config/credentials.yml.enc" ".env*")
for file in "${SENSITIVE_FILES[@]}"; do
    if [ -f "$file" ]; then
        PERMS=$(stat -c "%a" "$file" 2>/dev/null || stat -f "%A" "$file" 2>/dev/null || echo "unknown")
        echo "ðŸ”’ $file: $PERMS"
    fi
done

# Gemfileè„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆbundle auditãŒã‚ã‚Œã°ï¼‰
if command -v bundle > /dev/null && bundle show bundler-audit > /dev/null 2>&1; then
    echo "ðŸ›¡ï¸ Gemè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."
    bundle audit --update > /dev/null 2>&1 || echo "âš ï¸ è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
else
    echo "â„¹ï¸ bundler-auditãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæŽ¨å¥¨: gem install bundler-auditï¼‰"
fi

# 6. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
echo ""
echo "6ï¸âƒ£ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯..."

# Bundlerä¾å­˜é–¢ä¿‚ç¢ºèª
if [ -f "Gemfile.lock" ]; then
    echo "ðŸ“¦ Gemä¾å­˜é–¢ä¿‚ç¢ºèªä¸­..."
    bundle check > /dev/null 2>&1 || echo "âš ï¸ bundle installãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“"
fi

# 7. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo ""
echo "7ï¸âƒ£ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."

REPORT_FILE="maintenance/reports/daily_report_${BACKUP_DATE}.txt"
cat > "$REPORT_FILE" << EOF
# æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ

å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')
ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${HEALTH_STATUS}

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŽ‡: ${DISK_USAGE}%
- ã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}ä»¶

## å®Ÿè¡Œã•ã‚ŒãŸä½œæ¥­
- âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–
- âœ… ãƒ­ã‚°åˆ†æžãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
- âœ… ä¾å­˜é–¢ä¿‚ç¢ºèª

## æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
$([ "$DISK_USAGE" -gt 80 ] && echo "- âš ï¸ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã®ç¢ºèªãƒ»æ¸…ç†" || echo "- âœ… ç‰¹åˆ¥ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦")
$([ "$ERROR_COUNT" -gt 10 ] && echo "- âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°ç¢ºèª" || echo "- âœ… ã‚¨ãƒ©ãƒ¼çŠ¶æ³è‰¯å¥½")

---
Generated by: è‡ªå‹•ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ 
System: dentalsystem (A+ã‚°ãƒ¬ãƒ¼ãƒ‰å²ä¸Šæœ€å¼·ã‚·ã‚¹ãƒ†ãƒ )
EOF

echo "ðŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: $REPORT_FILE"

# 8. å®Œäº†é€šçŸ¥
echo ""
echo "=============================================="
echo "âœ… æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†"
echo "å®Ÿè¡Œæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${HEALTH_STATUS}"
echo "æ¬¡å›žå®Ÿè¡Œ: $(date -d '+1 day' '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -v+1d '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo 'æ˜Žæ—¥åŒæ™‚åˆ»')"
echo "=============================================="

# ãƒ­ã‚°ã«è¨˜éŒ²
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [MAINTENANCE] æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº† - çŠ¶æ…‹: ${HEALTH_STATUS}" >> development/development_log.txt

# æ­£å¸¸çµ‚äº†
exit 0