#!/bin/bash

# ==================================================
# ãƒ‡ãƒ—ãƒ­ã‚¤é˜»å®³è¦å›  å…¨é¢æ”¹å–„ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Generated by Quartet Automation System
# ==================================================

PROJECT_NAME=${1:-dentalsystem}
LOG_FILE="logs/deploy-fix-$(date '+%Y%m%d_%H%M%S').log"

# ã‚«ãƒ©ãƒ¼è¨­å®š
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

echo -e "${PURPLE}===================================================${NC}"
echo -e "${PURPLE}    ãƒ‡ãƒ—ãƒ­ã‚¤é˜»å®³è¦å›  å…¨é¢æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ ${NC}"
echo -e "${PURPLE}===================================================${NC}"

mkdir -p logs

echo "[$(date '+%Y-%m-%d %H:%M:%S')] ãƒ‡ãƒ—ãƒ­ã‚¤ä¿®å¾©é–‹å§‹" >> $LOG_FILE

# Phase 1: GitçŠ¶æ³ã®æ­£å¸¸åŒ–
fix_git_status() {
    echo -e "\n${BLUE}=== Phase 1: GitçŠ¶æ³æ­£å¸¸åŒ– ===${NC}"
    
    echo -e "${CYAN}GitçŠ¶æ³åˆ†æžä¸­...${NC}"
    
    # æœªè¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†
    echo -e "${YELLOW}æœªè¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†ä¸­...${NC}"
    
    # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’Gitã«è¿½åŠ 
    git add .ruby-version 2>/dev/null || true
    git add Gemfile.lock 2>/dev/null || true
    git add Rakefile 2>/dev/null || true
    git add config.ru 2>/dev/null || true
    git add config/environment.rb 2>/dev/null || true
    git add bin/rails 2>/dev/null || true
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
    git add config/cli-quartet-config.yaml 2>/dev/null || true
    git add config/quartet-automation.yaml 2>/dev/null || true
    git add quartet-automation-master.sh 2>/dev/null || true
    git add setup-cli-quartet.sh 2>/dev/null || true
    
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
    git add scripts/ 2>/dev/null || true
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’è¿½åŠ 
    git add app/assets/config/ 2>/dev/null || true
    
    echo -e "${GREEN}âœ… GitçŠ¶æ³æ­£å¸¸åŒ–å®Œäº†${NC}"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] GitçŠ¶æ³æ­£å¸¸åŒ–å®Œäº†" >> $LOG_FILE
}

# Phase 2: ä¾å­˜é–¢ä¿‚ã®ä¿®å¾©
fix_dependencies() {
    echo -e "\n${BLUE}=== Phase 2: ä¾å­˜é–¢ä¿‚ä¿®å¾© ===${NC}"
    
    if [[ -f "Gemfile" ]]; then
        echo -e "${CYAN}Rubyä¾å­˜é–¢ä¿‚ç¢ºèªãƒ»ä¿®å¾©ä¸­...${NC}"
        
        # Bundleræ›´æ–°
        gem install bundler --conservative || true
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        bundle config set --local deployment false
        bundle install
        
        # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        if bundle check > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… Rubyä¾å­˜é–¢ä¿‚æ­£å¸¸${NC}"
        else
            echo -e "${YELLOW}âš ï¸ ä¾å­˜é–¢ä¿‚å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œä¸­...${NC}"
            bundle install --retry=3
        fi
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ä¾å­˜é–¢ä¿‚ä¿®å¾©å®Œäº†" >> $LOG_FILE
}

# Phase 3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–
fix_configuration() {
    echo -e "\n${BLUE}=== Phase 3: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æœ€é©åŒ– ===${NC}"
    
    # ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    if [[ ! -f ".env" ]]; then
        if [[ -f ".env.example" ]]; then
            echo -e "${CYAN}.envãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...${NC}"
            cp .env.example .env
            echo -e "${GREEN}âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†${NC}"
        fi
    fi
    
    # Rubyç’°å¢ƒè¨­å®š
    if [[ ! -f ".ruby-version" ]]; then
        echo "3.3.0" > .ruby-version
        echo -e "${GREEN}âœ… .ruby-versionãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ${NC}"
    fi
    
    # Railsè¨­å®šç¢ºèª
    if [[ -f "config/application.rb" ]]; then
        echo -e "${CYAN}Railsè¨­å®šç¢ºèªä¸­...${NC}"
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šç¢ºèª
        if [[ -f "config/database.yml" ]]; then
            echo -e "${GREEN}âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šç¢ºèªæ¸ˆã¿${NC}"
        fi
        
        # ç§˜å¯†éµè¨­å®šç¢ºèª
        if [[ ! -f "config/master.key" ]] && [[ ! -f "config/credentials.yml.enc" ]]; then
            echo -e "${YELLOW}ç§˜å¯†éµè¨­å®šç”Ÿæˆä¸­...${NC}"
            rails credentials:edit --environment development 2>/dev/null || true
        fi
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æœ€é©åŒ–å®Œäº†" >> $LOG_FILE
}

# Phase 4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ä¿®å¾©
fix_database() {
    echo -e "\n${BLUE}=== Phase 4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ä¿®å¾© ===${NC}"
    
    if [[ -f "config/database.yml" ]]; then
        echo -e "${CYAN}ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ç¢ºèªãƒ»ä¿®å¾©ä¸­...${NC}"
        
        # é–‹ç™ºç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
        RAILS_ENV=development rails db:create 2>/dev/null || true
        RAILS_ENV=development rails db:migrate 2>/dev/null || true
        
        # ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™  
        RAILS_ENV=test rails db:create 2>/dev/null || true
        RAILS_ENV=test rails db:migrate 2>/dev/null || true
        
        echo -e "${GREEN}âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ä¿®å¾©å®Œäº†${NC}"
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿®å¾©å®Œäº†" >> $LOG_FILE
}

# Phase 5: ã‚¢ã‚»ãƒƒãƒˆãƒ»é™çš„ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
fix_assets() {
    echo -e "\n${BLUE}=== Phase 5: ã‚¢ã‚»ãƒƒãƒˆãƒ»é™çš„ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ ===${NC}"
    
    if [[ -f "config/application.rb" ]]; then
        echo -e "${CYAN}ã‚¢ã‚»ãƒƒãƒˆæº–å‚™ä¸­...${NC}"
        
        # ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
        RAILS_ENV=development rails assets:precompile 2>/dev/null || true
        
        # ã‚¢ã‚»ãƒƒãƒˆç¢ºèª
        if [[ -d "public/assets" ]]; then
            echo -e "${GREEN}âœ… ã‚¢ã‚»ãƒƒãƒˆæº–å‚™å®Œäº†${NC}"
        fi
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ã‚¢ã‚»ãƒƒãƒˆæº–å‚™å®Œäº†" >> $LOG_FILE
}

# Phase 6: æ¨©é™ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
fix_permissions() {
    echo -e "\n${BLUE}=== Phase 6: æ¨©é™ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š ===${NC}"
    
    echo -e "${CYAN}ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™æœ€é©åŒ–ä¸­...${NC}"
    
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œæ¨©é™
    find scripts/ -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
    chmod +x quartet-automation-master.sh 2>/dev/null || true
    chmod +x setup-cli-quartet.sh 2>/dev/null || true
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é©åˆ‡ãªæ¨©é™
    find config/ -name "*.yml" -exec chmod 644 {} \; 2>/dev/null || true
    find config/ -name "*.yaml" -exec chmod 644 {} \; 2>/dev/null || true
    
    # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™
    chmod 755 logs/ 2>/dev/null || true
    find logs/ -type f -exec chmod 644 {} \; 2>/dev/null || true
    
    # ç§˜å¯†æƒ…å ±ä¿è­·
    chmod 600 .env 2>/dev/null || true
    
    echo -e "${GREEN}âœ… æ¨©é™è¨­å®šå®Œäº†${NC}"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] æ¨©é™è¨­å®šå®Œäº†" >> $LOG_FILE
}

# Phase 7: ç’°å¢ƒãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼
verify_deployment_readiness() {
    echo -e "\n${BLUE}=== Phase 7: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™çŠ¶æ³æ¤œè¨¼ ===${NC}"
    
    local issues=0
    
    echo -e "${CYAN}ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™çŠ¶æ³ãƒã‚§ãƒƒã‚¯ä¸­...${NC}"
    
    # GitçŠ¶æ³ãƒã‚§ãƒƒã‚¯
    if git status --porcelain | wc -l | xargs test 0 -lt; then
        echo -e "${YELLOW}âš ï¸ æœªã‚³ãƒŸãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Š${NC}"
        issues=$((issues + 1))
    else
        echo -e "${GREEN}âœ… GitçŠ¶æ³ã‚¯ãƒªãƒ¼ãƒ³${NC}"
    fi
    
    # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    if [[ -f "Gemfile" ]]; then
        if bundle check > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… ä¾å­˜é–¢ä¿‚æ­£å¸¸${NC}"
        else
            echo -e "${RED}âŒ ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼${NC}"
            issues=$((issues + 1))
        fi
    fi
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    if [[ -f ".env" ]]; then
        echo -e "${GREEN}âœ… ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨${NC}"
    else
        echo -e "${YELLOW}âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«æœªè¨­å®š${NC}"
        issues=$((issues + 1))
    fi
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¯èƒ½ãªå ´åˆï¼‰
    if [[ -f "Rakefile" ]]; then
        echo -e "${CYAN}ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...${NC}"
        if rails test:system 2>/dev/null || rails test 2>/dev/null || rspec 2>/dev/null; then
            echo -e "${GREEN}âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ${NC}"
        else
            echo -e "${YELLOW}âš ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å•é¡Œï¼ˆç¶™ç¶šå¯èƒ½ï¼‰${NC}"
            issues=$((issues + 1))
        fi
    fi
    
    # çµæžœã‚µãƒžãƒªãƒ¼
    if [ $issues -eq 0 ]; then
        echo -e "\n${GREEN}ðŸŽ‰ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ï¼${NC}"
        echo -e "${GREEN}ã™ã¹ã¦ã®é˜»å®³è¦å› ãŒè§£æ±ºã•ã‚Œã¾ã—ãŸ${NC}"
    else
        echo -e "\n${YELLOW}âš ï¸ $issueså€‹ã®èª²é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™${NC}"
        echo -e "${CYAN}æ‰‹å‹•ç¢ºèªãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™${NC}"
    fi
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] æ¤œè¨¼å®Œäº† - èª²é¡Œæ•°: $issues" >> $LOG_FILE
}

# Phase 8: æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥æº–å‚™
prepare_final_commit() {
    echo -e "\n${BLUE}=== Phase 8: æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆæº–å‚™ ===${NC}"
    
    echo -e "${CYAN}ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã‚³ãƒŸãƒƒãƒˆä½œæˆä¸­...${NC}"
    
    # ã™ã¹ã¦ã®ä¿®æ­£ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
    git add -A
    
    # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
    cat > /tmp/deploy-fix-commit.txt << EOF
feat: ãƒ‡ãƒ—ãƒ­ã‚¤é˜»å®³è¦å› å…¨é¢æ”¹å–„

- GitçŠ¶æ³æ­£å¸¸åŒ–ï¼ˆæœªè¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†ï¼‰
- Rubyä¾å­˜é–¢ä¿‚ä¿®å¾©ï¼ˆbundle installï¼‰
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æœ€é©åŒ–ï¼ˆ.env, .ruby-versionç­‰ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ³ä¿®å¾©
- ã‚¢ã‚»ãƒƒãƒˆãƒ»é™çš„ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
- æ¨©é™ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæœ€é©åŒ–
- Quartetè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ

ðŸ¤– Generated with Quartet Automation System
ðŸš€ Deploy Ready Status: Achieved

Co-Authored-By: PRESIDENT <president@quartet.ai>
Co-Authored-By: Claude-Code <claude@quartet.ai>
Co-Authored-By: Gemini-CLI <gemini@quartet.ai>
Co-Authored-By: Codex-CLI <codex@quartet.ai>
EOF
    
    # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
    git commit -F /tmp/deploy-fix-commit.txt
    rm /tmp/deploy-fix-commit.txt
    
    echo -e "${GREEN}âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã‚³ãƒŸãƒƒãƒˆå®Œäº†${NC}"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] æœ€çµ‚ã‚³ãƒŸãƒƒãƒˆå®Œäº†" >> $LOG_FILE
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
main() {
    echo -e "${PURPLE}ãƒ‡ãƒ—ãƒ­ã‚¤é˜»å®³è¦å› ã®å…¨é¢æ”¹å–„ã‚’é–‹å§‹ã—ã¾ã™${NC}"
    echo -e "${CYAN}å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_NAME${NC}"
    
    fix_git_status
    fix_dependencies
    fix_configuration
    fix_database
    fix_assets
    fix_permissions
    verify_deployment_readiness
    prepare_final_commit
    
    echo -e "\n${PURPLE}===================================================${NC}"
    echo -e "${PURPLE}    ãƒ‡ãƒ—ãƒ­ã‚¤é˜»å®³è¦å› æ”¹å–„å®Œäº†${NC}"
    echo -e "${PURPLE}===================================================${NC}"
    echo -e "${GREEN}ðŸ“‹ è©³ç´°ãƒ­ã‚°: $LOG_FILE${NC}"
    echo -e "${CYAN}ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„${NC}"
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] å…¨é¢æ”¹å–„å®Œäº†" >> $LOG_FILE
}

# å®Ÿè¡Œ
main "$@"